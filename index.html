<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofiia | Tutor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfd; }
        .tab-btn.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; }
        @media (max-width: 1024px) { .grid-5 { grid-template-columns: 1fr; } }
        .slot-free { background: #f0fdf4; border: 1px solid #dcfce7; color: #166534; }
        .slot-busy { background: #f9fafb; border: 1px solid #f3f4f6; color: #9ca3af; }
    </style>
</head>
<body class="pb-10">

    <div class="max-w-[1200px] mx-auto px-4 py-4">
        <nav class="flex justify-center bg-white p-1 rounded-xl shadow-sm border mb-6 sticky top-4 z-50">
            <button onclick="showTab('public', this)" class="tab-btn active flex-1 px-4 py-2 rounded-lg text-sm font-semibold transition-all">–í—ñ–∫–æ–Ω—Ü—è</button>
            <button onclick="showTab('private', this)" class="tab-btn flex-1 px-4 py-2 rounded-lg text-sm font-semibold text-slate-500 transition-all">–ú—ñ–π —Ä–æ–∑–∫–ª–∞–¥</button>
            <button onclick="showTab('log', this)" class="tab-btn flex-1 px-4 py-2 rounded-lg text-sm font-semibold text-slate-500 transition-all">–ñ—É—Ä–Ω–∞–ª</button>
        </nav>

        <div id="public" class="tab-content block">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-xl font-bold text-slate-800">–í—ñ–ª—å–Ω—ñ –º—ñ—Å—Ü—è ‚ú®</h2>
                    <button onclick="copyFreeHours()" class="text-indigo-600 border border-indigo-200 px-3 py-1 rounded-lg text-xs font-bold hover:bg-indigo-50 transition">–ö–æ–ø—ñ—é–≤–∞—Ç–∏ üìã</button>
                </div>
                <div id="public-week" class="grid-5"></div>
            </div>
        </div>

        <div id="private" class="tab-content hidden">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="text-xl font-bold text-slate-800 mb-5">–†–æ–±–æ—á–∏–π –≥—Ä–∞—Ñ—ñ–∫</h2>
                <div id="private-week" class="grid-5"></div>
            </div>
        </div>

        <div id="log" class="tab-content hidden text-sm">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase">
                        <tr><th class="p-4">–î–∞—Ç–∞ / –£—á–µ–Ω—å</th><th class="p-4">–¢–µ–º–∞</th><th class="p-4 text-center">–ë–∞–ª</th></tr>
                    </thead>
                    <tbody id="log-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø (–í–°–¢–ê–í –°–í–û–Ñ) ---
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQgrwL7j8Mlat4GqhSWe9xAivXD_PzWZ0TRedmHRgVuv_x6Hv7J_Kf4B8duzcN6asmBwCureC2q8toG/pub?output=csv";
        
        // –ó–Ω–∞–π–¥–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤ Apps Script (Manage Deployments -> Web App URL) —ñ –≤—Å—Ç–∞–≤ —Å—é–¥–∏:
        const API_URL = "https://script.google.com/macros/s/AKfycbx8spV7-VAOd2M6bmXUT1pg3nSMtHQ6NenIBQQAcBEIeQRlYEadieVUAzCQsNkLFWcV/exec";

        const DAYS = ["–ü–æ–Ω–µ–¥—ñ–ª–æ–∫", "–í—ñ–≤—Ç–æ—Ä–æ–∫", "–°–µ—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä", "–ü'—è—Ç–Ω–∏—Ü—è"];
        let freeSlotsText = "";

        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.replace('block', 'hidden'));
            document.getElementById(tabId).classList.replace('hidden', 'block');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-slate-500'));
            btn.classList.add('active');
        }

        async function loadData() {
            try {
                const res = await fetch(SHEET_URL);
                const text = await res.text();
                const sep = text.split('\n')[0].includes(';') ? ';' : ',';
                const rows = text.split('\n').slice(1).filter(r => r.trim());
                const dayData = { "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫": [], "–í—ñ–≤—Ç–æ—Ä–æ–∫": [], "–°–µ—Ä–µ–¥–∞": [], "–ß–µ—Ç–≤–µ—Ä": [], "–ü'—è—Ç–Ω–∏—Ü—è": [] };

                rows.forEach(line => {
                    const col = line.split(separator).map(c => c.replace(/^"|"$/g, '').trim());
                    const dayName = col[0] ? col[0].split(' ')[0] : "";
                    if (dayData[dayName]) dayData[dayName].push({ 
                        date: col[0], time: col[1], student: col[2], subject: col[3],
                        link: col[4], status: col[5], topic: col[6], grade: col[8] 
                    });
                });
                renderPublic(dayData); renderPrivate(dayData); renderLog(rows, sep);
            } catch (err) { console.error(err); }
        }

        function renderPublic(data) {
            const grid = document.getElementById('public-week'); grid.innerHTML = '';
            let copyText = "–í—ñ–ª—å–Ω—ñ –≥–æ–¥–∏–Ω–∏:\n";
            DAYS.forEach(day => {
                let html = `<div class="space-y-2"><h3 class="text-[10px] text-slate-400 uppercase font-bold text-center mb-2">${day}</h3>`;
                data[day].forEach(s => {
                    const isFree = s.status.toLowerCase().includes('–≤—ñ–ª—å–Ω–æ');
                    const hour = parseInt(s.time);
                    if (hour < 16 && !s.student.includes("–í—Å–µ–≤–æ–ª–æ–¥")) return;
                    html += `<div class="p-2 rounded-lg text-center text-xs font-semibold ${isFree ? 'slot-free' : 'slot-busy'}">${s.time}</div>`;
                    if (isFree) copyText += `‚Ä¢ ${day}: ${s.time}\n`;
                });
                grid.innerHTML += html + `</div>`;
            });
            freeSlotsText = copyText;
        }

        function renderPrivate(data) {
            const grid = document.getElementById('private-week'); grid.innerHTML = '';
            DAYS.forEach(day => {
                let html = `<div class="space-y-3"><h3 class="text-[10px] text-indigo-400 uppercase font-bold text-center bg-indigo-50 py-1 rounded-lg mb-2">${day}</h3>`;
                data[day].forEach((s, idx) => {
                    if (s.status.toLowerCase().includes('–≤—ñ–ª—å–Ω–æ')) return;
                    const url = s.link.includes('http') ? s.link : 'https://meet.google.com';
                    const safeID = `${day}-${idx}`;
                    html += `<div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm space-y-3">
                        <div class="flex justify-between items-start">
                            <div class="text-[10px] font-bold text-indigo-500 uppercase">${s.time}</div>
                            <a href="${url}" target="_blank" class="text-[10px] text-indigo-600 font-bold hover:underline">–£–†–û–ö ‚Æï</a>
                        </div>
                        <div class="font-bold text-sm text-slate-800">${s.student}</div>
                        <input type="text" id="t-${safeID}" placeholder="–¢–µ–º–∞" value="${s.topic || ''}" class="w-full text-[10px] p-2 bg-slate-50 rounded-lg outline-none border-none focus:ring-1 focus:ring-indigo-400">
                        <div class="flex gap-1">
                            <input type="text" id="g-${safeID}" placeholder="–ë–∞–ª" value="${s.grade || ''}" class="w-10 text-[10px] p-2 bg-slate-50 rounded-lg text-center">
                            <button onclick="saveData('${s.date}', '${s.time}', '${s.student}', '${safeID}')" class="flex-1 bg-indigo-600 text-white text-[9px] font-bold py-2 rounded-lg active:scale-95 transition">–ó–ë–ï–†–ï–ì–¢–ò</button>
                        </div>
                    </div>`;
                });
                grid.innerHTML += html + `</div>`;
            });
        }

        async function saveData(day, time, student, id) {
            const topic = document.getElementById(`t-${id}`).value;
            const grade = document.getElementById(`g-${id}`).value;
            const btn = event.target; btn.innerText = "...";
            try {
                await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ day, time, student, topic, grade }) });
                btn.innerText = "OK ‚úì"; btn.style.backgroundColor = "#22c55e";
                setTimeout(() => { btn.innerText = "–ó–ë–ï–†–ï–ì–¢–ò"; btn.style.backgroundColor = "#4f46e5"; }, 2000);
            } catch (e) { btn.innerText = "Error"; }
        }

        function renderLog(rows, sep) {
            const body = document.getElementById('log-body'); body.innerHTML = '';
            rows.forEach(r => {
                const c = r.split(sep).map(col => col.replace(/^"|"$/g, '').trim());
                if (!c[6] || c[6] === '-') return;
                body.innerHTML += `<tr class="hover:bg-slate-50 transition">
                    <td class="p-3"><div class="text-[9px] text-slate-300">${c[0]}</div><div class="font-bold">${c[2]}</div></td>
                    <td class="p-3 text-xs text-slate-500 italic">${c[6]}</td>
                    <td class="p-3 text-center font-bold text-indigo-600">${c[8] || '-'}</td>
                </tr>`;
            });
        }

        function copyFreeHours() { navigator.clipboard.writeText(freeSlotsText).then(() => alert("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ! ‚ú®")); }
        loadData();
    </script>
</body>
</html>
