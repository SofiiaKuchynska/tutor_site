<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ 7 –∫–ª–∞—Å: –í—Å—Ç—É–ø —Ç–∞ –û—Å–Ω–æ–≤–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .task-card { border: 1px solid #e2e8f0; transition: all 0.3s ease; }
        .task-card:hover { border-color: #3b82f6; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1); transform: translateY(-2px); }
        .canvas-container { position: relative; background: #ffffff; cursor: crosshair; touch-action: none; }
        .tool-active { background-color: #2563eb; color: #ffffff; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4); }
        .option-btn { transition: all 0.2s; }
        .option-btn:hover:not(:disabled) { background-color: #f1f5f9; border-color: #94a3b8; }
        .option-correct { background-color: #dcfce7 !important; border-color: #22c55e !important; color: #166534 !important; }
        .option-wrong { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; }
    </style>
</head>
<body class="h-screen flex text-slate-900">

    <div class="w-full lg:w-1/2 flex flex-col bg-white border-r border-slate-200 shadow-xl z-10 relative">
        <header class="p-5 border-b border-slate-100 flex justify-between items-center bg-white/95 backdrop-blur-md sticky top-0 z-30">
            <div>
                <h1 class="text-2xl font-extrabold tracking-tight text-slate-800">–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: 7 –∫–ª–∞—Å</h1>
                <p class="text-[11px] font-bold text-indigo-500 uppercase tracking-widest mt-1">–†—ñ–≤–µ–Ω—å: –û–∑–Ω–∞–π–æ–º—á–∏–π ‚Ä¢ –ê–ª–≥–µ–±—Ä–∞ —Ç–∞ –ì–µ–æ–º–µ—Ç—Ä—ñ—è</p>
            </div>
            <div class="flex flex-col items-end w-32">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-bold text-slate-500">–ü—Ä–æ–≥—Ä–µ—Å</span>
                    <span id="prog-text" class="text-xs font-black text-indigo-600">0/20</span>
                </div>
                <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                    <div id="prog-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 lg:p-10 space-y-12 custom-scrollbar pb-32">
            
            <section class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-3xl p-6 border border-indigo-100">
                <div class="flex items-start gap-4">
                    <div class="text-4xl">üëã</div>
                    <div>
                        <h2 class="text-xl font-bold text-indigo-900 mb-2">–ü—Ä–∏–≤—ñ—Ç! –¶–µ –ø—Ä–æ–±–Ω–∏–π —É—Ä–æ–∫.</h2>
                        <p class="text-indigo-800/80 text-sm leading-relaxed mb-4">
                            –¢—É—Ç –∑—ñ–±—Ä–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è, —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–≤–æ—é –±–∞–∑—É –∑–∞ 6 –∫–ª–∞—Å —Ç–∞ –æ—Å–Ω–æ–≤–∏ 7 –∫–ª–∞—Å—É. –ü–æ—á–Ω–µ–º–æ –∑ –ª–µ–≥–∫–æ–≥–æ (–¥—Ä–æ–±–∏, –ø–µ—Ä–∏–º–µ—Ç—Ä) —ñ –¥—ñ–π–¥–µ–º–æ –¥–æ —Ä—ñ–≤–Ω—è–Ω—å —Ç–∞ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫—ñ–≤. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π <b>–ü—ñ–¥–∫–∞–∑–∫–∏</b>, —è–∫—â–æ –∑–∞–±—É–≤ –ø—Ä–∞–≤–∏–ª–æ!
                        </p>
                        <details class="group bg-white rounded-2xl border border-indigo-200 overflow-hidden transition-all">
                            <summary class="cursor-pointer p-4 font-bold text-indigo-700 text-sm flex justify-between items-center bg-indigo-50/50 hover:bg-indigo-100/50">
                                üìö –®–ø–∞—Ä–≥–∞–ª–∫–∞: –û—Å–Ω–æ–≤–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞
                                <span class="transition group-open:rotate-180">‚ñº</span>
                            </summary>
                            <div class="p-4 text-sm text-slate-600 space-y-3 bg-white border-t border-indigo-100">
                                <p><b>–î—Ä–æ–±–∏:</b> –©–æ–± –¥–æ–¥–∞—Ç–∏ –¥—Ä–æ–±–∏ –∑ —Ä—ñ–∑–Ω–∏–º–∏ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫–∞–º–∏, –∑–Ω–∞–π–¥–∏ —Å–ø—ñ–ª—å–Ω–∏–π –∑–Ω–∞–º–µ–Ω–Ω–∏–∫.</p>
                                <p><b>–°—Ç–µ–ø–µ–Ω—ñ:</b> –ü—Ä–∏ –º–Ω–æ–∂–µ–Ω–Ω—ñ —Å—Ç–µ–ø–µ–Ω—ñ–≤ –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º–∏ –æ—Å–Ω–æ–≤–∞–º–∏ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –¥–æ–¥–∞—é—Ç—å—Å—è: \( a^m \cdot a^n = a^{m+n} \).</p>
                                <p><b>–ì–µ–æ–º–µ—Ç—Ä—ñ—è:</b> –ü–µ—Ä–∏–º–µ—Ç—Ä ‚Äî —Ü–µ —Å—É–º–∞ –¥–æ–≤–∂–∏–Ω —É—Å—ñ—Ö —Å—Ç–æ—Ä—ñ–Ω. –°—É–º—ñ–∂–Ω—ñ –∫—É—Ç–∏ –≤ —Å—É–º—ñ –¥–∞—é—Ç—å \(180^\circ\).</p>
                            </div>
                        </details>
                    </div>
                </div>
            </section>

            <section class="space-y-6">
                <div class="flex items-center gap-4 border-b border-slate-100 pb-4">
                    <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center text-xl shadow-inner shadow-blue-200">üî¢</div>
                    <h2 class="text-3xl font-black text-slate-800">–ë–ª–æ–∫ 1. –ê–ª–≥–µ–±—Ä–∞ —Ç–∞ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è</h2>
                </div>
                <div id="algebra-tasks" class="space-y-5"></div>
            </section>

            <div class="w-full h-px bg-gradient-to-r from-transparent via-slate-200 to-transparent my-10"></div>

            <section class="space-y-6">
                <div class="flex items-center gap-4 border-b border-slate-100 pb-4">
                    <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center text-xl shadow-inner shadow-emerald-200">üìê</div>
                    <h2 class="text-3xl font-black text-slate-800">–ë–ª–æ–∫ 2. –ì–µ–æ–º–µ—Ç—Ä—ñ—è —Ç–∞ —Ñ—ñ–≥—É—Ä–∏</h2>
                </div>
                
                <div class="bg-slate-900 rounded-3xl p-6 text-white text-center relative overflow-hidden group mb-6">
                    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiMzMzQxNTUiLz48L3N2Zz4=')] opacity-30"></div>
                    <div class="relative z-10 flex flex-col items-center">
                        <svg class="w-16 h-16 mb-2 text-emerald-400 transform group-hover:scale-110 transition duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"></path>
                        </svg>
                        <h3 class="font-bold text-lg">–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¥–æ—à–∫—É –ø—Ä–∞–≤–æ—Ä—É—á!</h3>
                        <p class="text-slate-400 text-xs">–ú–∞–ª—é–π –∫—É—Ç–∏ —Ç–∞ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∏, —â–æ–± –∫—Ä–∞—â–µ —É—è–≤–∏—Ç–∏ –∑–∞–¥–∞—á—É.</p>
                    </div>
                </div>

                <div id="geometry-tasks" class="space-y-5"></div>
            </section>

            <div class="pt-8 border-t border-slate-200 text-center">
                <button onclick="finishLesson()" class="w-full md:w-2/3 mx-auto bg-slate-900 text-white py-5 rounded-3xl font-black text-lg hover:bg-indigo-600 transition-all shadow-lg shadow-indigo-200 transform hover:-translate-y-1 active:scale-95">
                    –ó–ê–í–ï–†–®–ò–¢–ò –£–†–û–ö
                </button>
            </div>
        </main>
    </div>

    <div class="hidden lg:flex w-1/2 flex-col bg-slate-50 relative p-6 h-screen">
        <div class="absolute top-8 left-1/2 -translate-x-1/2 z-40 flex items-center gap-2 bg-white p-2 rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100">
            <button onclick="setTool('pen')" id="tool-pen" class="p-3 rounded-xl tool-active transition" title="–û–ª—ñ–≤–µ—Ü—å">‚úèÔ∏è</button>
            <button onclick="setTool('eraser')" id="tool-eraser" class="p-3 rounded-xl hover:bg-slate-100 transition" title="–ì—É–º–∫–∞">üßΩ</button>
            <div class="w-px h-8 bg-slate-200 mx-1"></div>
            <button onclick="toggleGrid()" id="tool-grid" class="px-3 py-2 text-xs font-bold text-slate-500 hover:bg-slate-100 rounded-lg transition" title="–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞ —Å—ñ—Ç–∫–∞">üåê –°—ñ—Ç–∫–∞</button>
            <button onclick="drawShape('triangle')" class="px-3 py-2 text-xs font-bold text-emerald-600 hover:bg-emerald-50 rounded-lg transition" title="–ù–∞–º–∞–ª—é–≤–∞—Ç–∏ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫">üî∫ –¢—Ä–∏–∫—É—Ç–Ω–∏–∫</button>
            <button onclick="drawShape('angle')" class="px-3 py-2 text-xs font-bold text-emerald-600 hover:bg-emerald-50 rounded-lg transition" title="–ù–∞–º–∞–ª—é–≤–∞—Ç–∏ –∫—É—Ç">üìê –ö—É—Ç</button>
            <div class="w-px h-8 bg-slate-200 mx-1"></div>
            <button onclick="clearCanvas()" class="p-3 text-red-500 hover:bg-red-50 rounded-xl transition" title="–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ">üóëÔ∏è</button>
        </div>

        <div class="canvas-container flex-1 bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden mt-16" id="canvas-wrap">
            <canvas id="whiteboard"></canvas>
        </div>
        
        <div class="mt-4 flex justify-between items-center px-2">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">–†–æ–∑—É–º–Ω–∞ –ß–µ—Ä–Ω–µ—Ç–∫–∞ ‚Ä¢ –ú–∞–ª—é–π —Ä–æ–∑–≤'—è–∑–∫–∏ —Ç—É—Ç</p>
        </div>
    </div>

    <div id="result-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] p-10 max-w-md w-full text-center shadow-2xl transform scale-95 transition-all" id="modal-content">
            <div class="text-6xl mb-4" id="res-emoji">üéØ</div>
            <h2 class="text-3xl font-black text-slate-800 mb-2">–£—Ä–æ–∫ –ó–∞–≤–µ—Ä—à–µ–Ω–æ!</h2>
            <div class="inline-block bg-indigo-50 border border-indigo-100 rounded-2xl px-6 py-3 mb-6">
                <p class="text-sm font-bold text-indigo-400 uppercase tracking-wide mb-1">–¢–≤—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                <p id="res-score" class="text-indigo-600 font-black text-4xl">0 / 20</p>
            </div>
            <p id="res-message" class="text-slate-600 mb-8 font-medium leading-relaxed"></p>
            <button onclick="location.reload()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-indigo-600 transition shadow-lg active:scale-95">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑</button>
        </div>
    </div>

<script>
    // --- –î–ê–ù–Ü –ó–ê–í–î–ê–ù–¨ (20 —à—Ç: 10 –ê–ª–≥–µ–±—Ä–∞ + 10 –ì–µ–æ–º–µ—Ç—Ä—ñ—è) ---
    const algebraTasks = [
        { 
            q: "–û–±—á–∏—Å–ª—ñ—Ç—å: \\( \\frac{1}{2} + \\frac{1}{4} \\)", 
            opts: ["\\( \\frac{3}{4} \\)", "\\( \\frac{2}{6} \\)", "\\( \\frac{1}{8} \\)"], a: 0, lvl: "–õ–µ–≥–∫–∏–π",
            h: "–ó–≤–µ–¥–∏ –¥–æ —Å–ø—ñ–ª—å–Ω–æ–≥–æ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫–∞. –°–ø—ñ–ª—å–Ω–∏–π –∑–Ω–∞–º–µ–Ω–Ω–∏–∫ –¥–ª—è 2 —ñ 4 ‚Äî —Ü–µ 4. \\( \\frac{1}{2} = \\frac{2}{4} \\).", s: "\\( \\frac{2}{4} + \\frac{1}{4} = \\frac{3}{4} \\)" 
        },
        { 
            q: "–ó–Ω–∞–π–¥—ñ—Ç—å –∫–æ—Ä—ñ–Ω—å –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä—ñ–≤–Ω—è–Ω–Ω—è: \\( 3x = 15 \\)", 
            opts: ["\\( x = 12 \\)", "\\( x = 5 \\)", "\\( x = 45 \\)"], a: 1, lvl: "–õ–µ–≥–∫–∏–π",
            h: "–©–æ–± –∑–Ω–∞–π—Ç–∏ –Ω–µ–≤—ñ–¥–æ–º–∏–π –º–Ω–æ–∂–Ω–∏–∫, —Ç—Ä–µ–±–∞ –¥–æ–±—É—Ç–æ–∫ –ø–æ–¥—ñ–ª–∏—Ç–∏ –Ω–∞ –≤—ñ–¥–æ–º–∏–π –º–Ω–æ–∂–Ω–∏–∫.", s: "\\( x = 15 : 3 \\Rightarrow x = 5 \\)" 
        },
        { 
            q: "–†–æ–∑–≤'—è–∂—ñ—Ç—å –ª—ñ–Ω—ñ–π–Ω–µ —Ä—ñ–≤–Ω—è–Ω–Ω—è: \\( 2x - 7 = 5 \\)", 
            opts: ["\\( x = 6 \\)", "\\( x = -1 \\)", "\\( x = 12 \\)"], a: 0, lvl: "–°–µ—Ä–µ–¥–Ω—ñ–π",
            h: "–ü–µ—Ä–µ–Ω–µ—Å–∏ -7 –≤ –ø—Ä–∞–≤—É —á–∞—Å—Ç–∏–Ω—É –∑—ñ –∑–Ω–∞–∫–æ–º –ø–ª—é—Å.", s: "\\( 2x = 5 + 7 \\Rightarrow 2x = 12 \\Rightarrow x = 6 \\)" 
        },
        { 
            q: "–ü–æ–¥–∞–π—Ç–µ —É –≤–∏–≥–ª—è–¥—ñ —Å—Ç–µ–ø–µ–Ω—è –¥–æ–±—É—Ç–æ–∫: \\( a^3 \\cdot a^4 \\)", 
            opts: ["\\( a^{12} \\)", "\\( a^7 \\)", "\\( a^1 \\)"], a: 1, lvl: "–õ–µ–≥–∫–∏–π",
            h: "–ü—Ä–∏ –º–Ω–æ–∂–µ–Ω–Ω—ñ —Å—Ç–µ–ø–µ–Ω—ñ–≤ –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º–∏ –æ—Å–Ω–æ–≤–∞–º–∏ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –¥–æ–¥–∞—é—Ç—å—Å—è.", s: "\\( a^{3+4} = a^7 \\)" 
        },
        { 
            q: "–ü—ñ–¥–Ω–µ—Å—ñ—Ç—å –æ–¥–Ω–æ—á–ª–µ–Ω –¥–æ —Å—Ç–µ–ø–µ–Ω—è: \\( (2x^2)^3 \\)", 
            opts: ["\\( 6x^5 \\)", "\\( 8x^6 \\)", "\\( 8x^5 \\)"], a: 1, lvl: "–°–µ—Ä–µ–¥–Ω—ñ–π",
            h: "–ü—ñ–¥–Ω–µ—Å–∏ –¥–æ 3-–≥–æ —Å—Ç–µ–ø–µ–Ω—è —á–∏—Å–ª–æ 2, –∞ –ø–æ–∫–∞–∑–Ω–∏–∫ –∑–º—ñ–Ω–Ω–æ—ó x –ø–æ–º–Ω–æ–∂ –Ω–∞ 3.", s: "\\( 2^3 \\cdot (x^2)^3 = 8x^6 \\)" 
        },
        { 
            q: "–ó–≤–µ–¥—ñ—Ç—å –ø–æ–¥—ñ–±–Ω—ñ –¥–æ–¥–∞–Ω–∫–∏: \\( 5x - 3x + 2x \\)", 
            opts: ["\\( 4x \\)", "\\( 10x \\)", "\\( 0 \\)"], a: 0, lvl: "–õ–µ–≥–∫–∏–π",
            h: "–ü—Ä–æ—Å—Ç–æ –≤–∏–∫–æ–Ω–∞–π –¥—ñ—ó –∑ —á–∏—Å–ª–∞–º–∏ –ø–µ—Ä–µ–¥ x: 5 - 3 + 2.", s: "\\( (5 - 3 + 2)x = 4x \\)" 
        },
        { 
            q: "–†–æ–∑–∫—Ä–∏–π—Ç–µ –¥—É–∂–∫–∏ —Ç–∞ —Å–ø—Ä–æ—Å—Ç—ñ—Ç—å –≤–∏—Ä–∞–∑: \\( (3x + 2) - (x - 4) \\)", 
            opts: ["\\( 2x - 2 \\)", "\\( 4x - 2 \\)", "\\( 2x + 6 \\)"], a: 2, lvl: "–°–µ—Ä–µ–¥–Ω—ñ–π",
            h: "–ü–µ—Ä–µ–¥ –¥—Ä—É–≥–∏–º–∏ –¥—É–∂–∫–∞–º–∏ —Å—Ç–æ—ó—Ç—å –º—ñ–Ω—É—Å, —Ç–æ–º—É –∑–Ω–∞–∫–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∑–º—ñ–Ω—é—é—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Ç–∏–ª–µ–∂–Ω—ñ.", s: "\\( 3x + 2 - x + 4 = 2x + 6 \\)" 
        },
        { 
            q: "–í–∏–Ω–µ—Å—ñ—Ç—å —Å–ø—ñ–ª—å–Ω–∏–π –º–Ω–æ–∂–Ω–∏–∫ –∑–∞ –¥—É–∂–∫–∏: \\( 6a^2 - 3a \\)", 
            opts: ["\\( 3a(2a - 1) \\)", "\\( 3a(a - 1) \\)", "\\( 3(2a^2 - a) \\)"], a: 0, lvl: "–°–µ—Ä–µ–¥–Ω—ñ–π",
            h: "–ù–∞–π–±—ñ–ª—å—à–µ —á–∏—Å–ª–æ, –Ω–∞ —è–∫–µ –¥—ñ–ª—è—Ç—å—Å—è 6 —ñ 3 ‚Äî —Ü–µ 3. –°–ø—ñ–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ ‚Äî a.", s: "\\( 3a \\cdot 2a - 3a \\cdot 1 = 3a(2a - 1) \\)" 
        },
        { 
            q: "–ü–µ—Ä–µ–º–Ω–æ–∂—Ç–µ –æ–¥–Ω–æ—á–ª–µ–Ω –Ω–∞ –º–Ω–æ–≥–æ—á–ª–µ–Ω: \\( 2x(x + 3) \\)", 
            opts: ["\\( 2x^2 + 6x \\)", "\\( 2x^2 + 3 \\)", "\\( 2x + 6x \\)"], a: 0, lvl: "–°–µ—Ä–µ–¥–Ω—ñ–π",
            h: "–ú–Ω–æ–∂–Ω–∏–∫ 2x —Ç—Ä–µ–±–∞ –ø–æ–º–Ω–æ–∂–∏—Ç–∏ –Ω–∞ –∫–æ–∂–µ–Ω –µ–ª–µ–º–µ–Ω—Ç —É –¥—É–∂–∫–∞—Ö.", s: "\\( 2x \\cdot x + 2x \\cdot 3 = 2x^2 + 6x \\)" 
        },
        { 
            q: "–†–æ–∑–∫–ª–∞–¥—ñ—Ç—å –Ω–∞ –º–Ω–æ–∂–Ω–∏–∫–∏ —Å–ø–æ—Å–æ–±–æ–º –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è: \\( ax + ay + 2x + 2y \\)", 
            opts: ["\\( (a+2)(x+y) \\)", "\\( (a+x)(2+y) \\)", "\\( a(x+y)+2 \\)"], a: 0, lvl: "–°–∫–ª–∞–¥–Ω–∏–π",
            h: "–ó–≥—Ä—É–ø—É–π –ø–µ—Ä—à—ñ –¥–≤–∞ –¥–æ–¥–∞–Ω–∫–∏ —ñ –æ—Å—Ç–∞–Ω–Ω—ñ –¥–≤–∞. –ó –ø–µ—Ä—à–æ—ó –ø–∞—Ä–∏ –≤–∏–Ω–µ—Å–∏ 'a', –∑ –¥—Ä—É–≥–æ—ó '2'.", s: "\\( a(x+y) + 2(x+y) = (a+2)(x+y) \\)" 
        }
    ];

    const geometryTasks = [
        { 
            q: "–ó–Ω–∞–π–¥—ñ—Ç—å –ø–µ—Ä–∏–º–µ—Ç—Ä –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∞ –∑—ñ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ 4 —Å–º —ñ 6 —Å–º.", 
            opts: ["\\( 24 \\text{ —Å–º} \\)", "\\( 10 \\text{ —Å–º} \\)", "\\( 20 \\text{ —Å–º} \\)"], a: 2, lvl: "–õ–µ–≥–∫–∏–π",
            h: "–ü–µ—Ä–∏–º–µ—Ç—Ä –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–∫–∞ ‚Äî —Ü–µ —Å—É–º–∞ –≤—Å—ñ—Ö –π–æ–≥–æ —á–æ—Ç–∏—Ä—å–æ—Ö —Å—Ç–æ—Ä—ñ–Ω.", s: "\\( P = 2 \\cdot (4 + 6) = 2 \\cdot 10 = 20 \\text{ —Å–º} \\)" 
        },
        { 
            q: "–ö—É—Ç, –≥—Ä–∞–¥—É—Å–Ω–∞ –º—ñ—Ä–∞ —è–∫–æ–≥–æ –¥–æ—Ä—ñ–≤–Ω—é—î \\( 90^\\circ \\), –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è...", 
            opts: ["–ì–æ—Å—Ç—Ä–∏–π", "–ü—Ä—è–º–∏–π", "–¢—É–ø–∏–π"], a: 1, lvl: "–õ–µ–≥–∫–∏–π",
            h: "–£—è–≤–∏ –∫—É—Ç –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Å—Ç–æ–ª—É –∞–±–æ –∞—Ä–∫—É—à–∞ –ø–∞–ø–µ—Ä—É.", s: "–ó–∞ –æ–∑–Ω–∞—á–µ–Ω–Ω—è–º, –∫—É—Ç \\( 90^\\circ \\) —î –ø—Ä—è–º–∏–º." 
        },
        { 
            q: "–°—É–º—ñ–∂–Ω—ñ –∫—É—Ç–∏ —Ä–∞–∑–æ–º —É—Ç–≤–æ—Ä—é—é—Ç—å —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏–π –∫—É—Ç. –Ø–∫–∞ —ó—Ö —Å—É–º–∞?", 
            opts: ["\\( 90^\\circ \\)", "\\( 180^\\circ \\)", "\\( 360^\\circ \\)"], a: 1, lvl: "–õ–µ–≥–∫–∏–π",
            h: "–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏–π –∫—É—Ç –≤–∏–≥–ª—è–¥–∞—î —è–∫ –ø—Ä—è–º–∞ –ª—ñ–Ω—ñ—è.", s: "–°—É–º–∞ —Å—É–º—ñ–∂–Ω–∏—Ö –∫—É—Ç—ñ–≤ –∑–∞–≤–∂–¥–∏ –¥–æ—Ä—ñ–≤–Ω—é—î \\( 180^\\circ \\)." 
        },
        { 
            q: "–û–¥–∏–Ω —ñ–∑ —Å—É–º—ñ–∂–Ω–∏—Ö –∫—É—Ç—ñ–≤ –¥–æ—Ä—ñ–≤–Ω—é—î \\( 130^\\circ \\). –ó–Ω–∞–π–¥—ñ—Ç—å —ñ–Ω—à–∏–π.", 
            opts: ["\\( 50^\\circ \\)", "\\( 130^\\circ \\)", "\\( 40^\\circ \\)"], a: 0, lvl: "–°–µ—Ä–µ–¥–Ω—ñ–π",
            h: "–ü–∞–º'—è—Ç–∞—î—à –ø–æ–ø–µ—Ä–µ–¥–Ω—î –∑–∞–≤–¥–∞–Ω–Ω—è? –á—Ö–Ω—è —Å—É–º–∞ \\( 180^\\circ \\).", s: "\\( 180^\\circ - 130^\\circ = 50^\\circ \\)" 
        },
        { 
            q: "–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ñ –∫—É—Ç–∏...", 
            opts: ["–í —Å—É–º—ñ –¥–∞—é—Ç—å \\( 180^\\circ \\)", "–†—ñ–≤–Ω—ñ –º—ñ–∂ —Å–æ–±–æ—é", "–ó–∞–≤–∂–¥–∏ –ø—Ä—è–º—ñ"], a: 1, lvl: "–õ–µ–≥–∫–∏–π",
            h: "–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ñ –∫—É—Ç–∏ —É—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∏–Ω—ñ –¥–≤–æ—Ö –ø—Ä—è–º–∏—Ö —ñ –ª–µ–∂–∞—Ç—å –æ–¥–∏–Ω –Ω–∞–≤–ø—Ä–æ—Ç–∏ –æ–¥–Ω–æ–≥–æ (—è–∫ –ø—ñ—Å–æ—á–Ω–∏–π –≥–æ–¥–∏–Ω–Ω–∏–∫).", s: "–ó–∞ —Ç–µ–æ—Ä–µ–º–æ—é –ø—Ä–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ñ –∫—É—Ç–∏, –≤–æ–Ω–∏ —Ä—ñ–≤–Ω—ñ." 
        },
        { 
            q: "–£ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫—É –¥–≤–∞ –∫—É—Ç–∏ –¥–æ—Ä—ñ–≤–Ω—é—é—Ç—å \\( 40^\\circ \\) —ñ \\( 60^\\circ \\). –ó–Ω–∞–π–¥—ñ—Ç—å —Ç—Ä–µ—Ç—ñ–π.", 
            opts: ["\\( 80^\\circ \\)", "\\( 100^\\circ \\)", "\\( 90^\\circ \\)"], a: 0, lvl: "–°–µ—Ä–µ–¥–Ω—ñ–π",
            h: "–°—É–º–∞ –≤—Å—ñ—Ö –∫—É—Ç—ñ–≤ –ë–£–î–¨-–Ø–ö–û–ì–û —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∞ –¥–æ—Ä—ñ–≤–Ω—é—î \\( 180^\\circ \\).", s: "\\( 180^\\circ - (40^\\circ + 60^\\circ) = 180^\\circ - 100^\\circ = 80^\\circ \\)" 
        },
        { 
            q: "–ü–µ—Ä–∏–º–µ—Ç—Ä —Ä—ñ–≤–Ω–æ–±–µ–¥—Ä–µ–Ω–æ–≥–æ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∞ 20 —Å–º. –û—Å–Ω–æ–≤–∞ –¥–æ—Ä—ñ–≤–Ω—é—î 6 —Å–º. –ó–Ω–∞–π–¥—ñ—Ç—å –±—ñ—á–Ω—É —Å—Ç–æ—Ä–æ–Ω—É.", 
            opts: ["\\( 14 \\text{ —Å–º} \\)", "\\( 7 \\text{ —Å–º} \\)", "\\( 8 \\text{ —Å–º} \\)"], a: 1, lvl: "–°–µ—Ä–µ–¥–Ω—ñ–π",
            h: "–£ —Ä—ñ–≤–Ω–æ–±–µ–¥—Ä–µ–Ω–æ–≥–æ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∞ –¥–≤—ñ –±—ñ—á–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏ —Ä—ñ–≤–Ω—ñ. –í—ñ–¥–Ω—ñ–º–∏ –æ—Å–Ω–æ–≤—É –≤—ñ–¥ –ø–µ—Ä–∏–º–µ—Ç—Ä–∞ —ñ –ø–æ–¥—ñ–ª–∏ –Ω–∞–≤–ø—ñ–ª.", s: "\\( (20 - 6) : 2 = 14 : 2 = 7 \\text{ —Å–º} \\)" 
        },
        { 
            q: "–ß–∏ —ñ—Å–Ω—É—î —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫ –∑—ñ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ 3 —Å–º, 4 —Å–º —ñ 8 —Å–º?", 
            opts: ["–¢–∞–∫", "–ù—ñ", "–¢—ñ–ª—å–∫–∏ –ø—Ä—è–º–æ–∫—É—Ç–Ω–∏–π"], a: 1, lvl: "–°–∫–ª–∞–¥–Ω–∏–π",
            h: "–ù–µ—Ä—ñ–≤–Ω—ñ—Å—Ç—å —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∞: –∫–æ–∂–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞ –º–∞—î –±—É—Ç–∏ –º–µ–Ω—à–æ—é –∑–∞ —Å—É–º—É –¥–≤–æ—Ö —ñ–Ω—à–∏—Ö. –ü–µ—Ä–µ–≤—ñ—Ä –Ω–∞–π–±—ñ–ª—å—à—É —Å—Ç–æ—Ä–æ–Ω—É.", s: "–°—É–º–∞ –¥–≤–æ—Ö –º–µ–Ω—à–∏—Ö —Å—Ç–æ—Ä—ñ–Ω: 3 + 4 = 7. –ê–ª–µ 7 –Ω–µ –±—ñ–ª—å—à–µ –∑–∞ 8. –¢–∞–∫–æ–≥–æ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∞ –Ω–µ —ñ—Å–Ω—É—î." 
        },
        { 
            q: "–ü–µ—Ä—à–∞ –æ–∑–Ω–∞–∫–∞ —Ä—ñ–≤–Ω–æ—Å—Ç—ñ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫—ñ–≤ - —Ü–µ —Ä—ñ–≤–Ω—ñ—Å—Ç—å –∑–∞...", 
            opts: ["–î–≤–æ–º–∞ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ —ñ –∫—É—Ç–æ–º –º—ñ–∂ –Ω–∏–º–∏", "–°—Ç–æ—Ä–æ–Ω–æ—é —ñ –¥–≤–æ–º–∞ –ø—Ä–∏–ª–µ–≥–ª–∏–º–∏ –∫—É—Ç–∞–º–∏", "–¢—Ä—å–æ–º–∞ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏"], a: 0, lvl: "–°–µ—Ä–µ–¥–Ω—ñ–π",
            h: "–ó–≥–∞–¥–∞–π –∞–∫—Å—ñ–æ–º–∏ –≥–µ–æ–º–µ—Ç—Ä—ñ—ó –∑ 7 –∫–ª–∞—Å—É.", s: "–ü–µ—Ä—à–∞ –æ–∑–Ω–∞–∫–∞: –∑–∞ –¥–≤–æ–º–∞ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ —ñ –∫—É—Ç–æ–º –º—ñ–∂ –Ω–∏–º–∏." 
        },
        { 
            q: "–£ –ø—Ä—è–º–æ–∫—É—Ç–Ω–æ–º—É —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫—É –≥—ñ–ø–æ—Ç–µ–Ω—É–∑–∞ –¥–æ—Ä—ñ–≤–Ω—é—î 10 —Å–º. –ó–Ω–∞–π–¥—ñ—Ç—å –∫–∞—Ç–µ—Ç, —â–æ –ª–µ–∂–∏—Ç—å –Ω–∞–≤–ø—Ä–æ—Ç–∏ –∫—É—Ç–∞ \\( 30^\\circ \\).", 
            opts: ["\\( 5 \\text{ —Å–º} \\)", "\\( 10 \\text{ —Å–º} \\)", "\\( 20 \\text{ —Å–º} \\)"], a: 0, lvl: "–°–∫–ª–∞–¥–Ω–∏–π",
            h: "–ö–∞—Ç–µ—Ç, —â–æ –ª–µ–∂–∏—Ç—å –Ω–∞–≤–ø—Ä–æ—Ç–∏ –∫—É—Ç–∞ \\( 30^\\circ \\), –º–∞—î –æ—Å–æ–±–ª–∏–≤—É –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å –ø–æ –≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—é –¥–æ –≥—ñ–ø–æ—Ç–µ–Ω—É–∑–∏.", s: "–í—ñ–Ω –¥–æ—Ä—ñ–≤–Ω—é—î –ø–æ–ª–æ–≤–∏–Ω—ñ –≥—ñ–ø–æ—Ç–µ–Ω—É–∑–∏: \\( 10 : 2 = 5 \\text{ —Å–º} \\)." 
        }
    ];

    const allTasks = [...algebraTasks, ...geometryTasks];
    let userAnswers = new Array(allTasks.length).fill(null);
    let correctCount = 0;

    // --- –†–ï–ù–î–ï–† –ö–û–ù–¢–ï–ù–¢–£ ---
    function renderTasks() {
        const algContainer = document.getElementById('algebra-tasks');
        const geoContainer = document.getElementById('geometry-tasks');

        algebraTasks.forEach((task, index) => {
            algContainer.innerHTML += generateTaskHTML(task, index, 'blue');
        });

        geometryTasks.forEach((task, index) => {
            geoContainer.innerHTML += generateTaskHTML(task, index + algebraTasks.length, 'emerald');
        });

        MathJax.typesetPromise();
    }

    function generateTaskHTML(task, id, color) {
        let badgeColor = task.lvl === '–õ–µ–≥–∫–∏–π' ? 'bg-green-100 text-green-700' : task.lvl === '–°–µ—Ä–µ–¥–Ω—ñ–π' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700';
        
        let optionsHTML = task.opts.map((opt, optIdx) => `
            <button id="btn-${id}-${optIdx}" onclick="selectOption(${id}, ${optIdx})" class="option-btn w-full text-left p-4 rounded-2xl border-2 border-slate-100 bg-slate-50 font-medium text-slate-700 flex items-center gap-3">
                <div class="w-5 h-5 rounded-full border-2 border-slate-300 flex-shrink-0 flex items-center justify-center" id="circle-${id}-${optIdx}"></div>
                <span>${opt}</span>
            </button>
        `).join('');

        return `
            <div id="card-${id}" class="task-card bg-white p-6 rounded-[2rem]">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 rounded-full bg-${color}-100 text-${color}-600 font-black flex items-center justify-center text-sm">${id + 1}</span>
                        <span class="px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wide ${badgeColor}">${task.lvl}</span>
                    </div>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-5 leading-relaxed">${task.q}</h3>
                
                <div class="grid grid-cols-1 gap-3 mb-5">
                    ${optionsHTML}
                </div>

                <div class="flex justify-between items-center pt-4 border-t border-slate-50">
                    <button onclick="toggleElement('hint-${id}')" class="text-xs font-bold text-slate-400 hover:text-indigo-500 uppercase flex items-center gap-1"><span class="text-base">üí°</span> –ü—ñ–¥–∫–∞–∑–∫–∞</button>
                    <button onclick="toggleElement('sol-${id}')" class="text-xs font-bold text-slate-400 hover:text-indigo-500 uppercase">–†—ñ—à–µ–Ω–Ω—è üëÅÔ∏è</button>
                </div>
                
                <div id="hint-${id}" class="hidden mt-4 p-4 bg-yellow-50/80 rounded-2xl text-sm border border-yellow-100 text-yellow-800 font-medium">
                    ${task.h}
                </div>
                <div id="sol-${id}" class="hidden mt-4 p-4 bg-indigo-50/80 rounded-2xl text-sm border border-indigo-100 text-indigo-800 italic">
                    –†–æ–∑–≤'—è–∑–∞–Ω–Ω—è: ${task.s}
                </div>
            </div>
        `;
    }

    // --- –õ–û–ì–Ü–ö–ê –¢–ï–°–¢–£–í–ê–ù–ù–Ø ---
    function selectOption(taskId, optIdx) {
        if (userAnswers[taskId] !== null) return;

        const task = allTasks[taskId];
        userAnswers[taskId] = optIdx;
        const isCorrect = optIdx === task.a;

        const selectedBtn = document.getElementById(`btn-${taskId}-${optIdx}`);
        const selectedCircle = document.getElementById(`circle-${taskId}-${optIdx}`);
        const correctBtn = document.getElementById(`btn-${taskId}-${task.a}`);
        const correctCircle = document.getElementById(`circle-${taskId}-${task.a}`);

        task.opts.forEach((_, i) => {
            const btn = document.getElementById(`btn-${taskId}-${i}`);
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');
        });

        if (isCorrect) {
            selectedBtn.classList.remove('bg-slate-50', 'border-slate-100', 'opacity-70');
            selectedBtn.classList.add('option-correct');
            selectedCircle.innerHTML = '<div class="w-2.5 h-2.5 bg-green-600 rounded-full"></div>';
            selectedCircle.classList.replace('border-slate-300', 'border-green-600');
            correctCount++;
        } else {
            selectedBtn.classList.remove('bg-slate-50', 'border-slate-100', 'opacity-70');
            selectedBtn.classList.add('option-wrong');
            selectedCircle.innerHTML = '<div class="w-2.5 h-2.5 bg-red-600 rounded-full"></div>';
            selectedCircle.classList.replace('border-slate-300', 'border-red-600');
            
            correctBtn.classList.remove('bg-slate-50', 'border-slate-100', 'opacity-70');
            correctBtn.classList.add('option-correct', 'opacity-100');
            correctCircle.innerHTML = '<div class="w-2.5 h-2.5 bg-green-600 rounded-full"></div>';
            correctCircle.classList.replace('border-slate-300', 'border-green-600');
        }

        updateProgress();
    }

    function updateProgress() {
        const answeredCount = userAnswers.filter(a => a !== null).length;
        const total = allTasks.length;
        document.getElementById('prog-text').innerText = `${answeredCount}/${total}`;
        document.getElementById('prog-bar').style.width = `${(answeredCount / total) * 100}%`;
    }

    function toggleElement(id) {
        const el = document.getElementById(id);
        el.classList.toggle('hidden');
    }

    function finishLesson() {
        const modal = document.getElementById('result-modal');
        const modalContent = document.getElementById('modal-content');
        const scoreEl = document.getElementById('res-score');
        const msgEl = document.getElementById('res-message');
        const emojiEl = document.getElementById('res-emoji');

        const total = allTasks.length;
        scoreEl.innerText = `${correctCount} / ${total}`;

        let percent = correctCount / total;
        if (percent >= 0.85) {
            emojiEl.innerText = "üèÜ";
            msgEl.innerHTML = "–ë–ª–∏—Å–∫—É—á–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –¢–∏ —á—É–¥–æ–≤–æ –ø–∞–º'—è—Ç–∞—î—à –º–∞—Ç–µ—Ä—ñ–∞–ª 6-–≥–æ –∫–ª–∞—Å—É —ñ –≤–∂–µ –≥–æ—Ç–æ–≤–∏–π –ø—ñ–¥–∫–æ—Ä—é–≤–∞—Ç–∏ —Å–∫–ª–∞–¥–Ω—ñ —Ç–µ–º–∏ 7-–≥–æ. –¢–∞–∫ —Ç—Ä–∏–º–∞—Ç–∏!";
        } else if (percent >= 0.5) {
            emojiEl.innerText = "üëç";
            msgEl.innerHTML = "–ì–∞—Ä–Ω–∞ —Ä–æ–±–æ—Ç–∞! –¢–∏ –¥–æ–±—Ä–µ –æ—Ä—ñ—î–Ω—Ç—É—î—à—Å—è –≤ –æ—Å–Ω–æ–≤–∞—Ö, —Ö–æ—á–∞ –¥–µ—è–∫—ñ —Ç–µ–º–∏ –≤–∞—Ä—Ç–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏. –£ —Ç–µ–±–µ —á—É–¥–æ–≤–∏–π –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª –¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è!";
        } else {
            emojiEl.innerText = "üí™";
            msgEl.innerHTML = "–¶–µ –±—É–ª–∞ —Ö–æ—Ä–æ—à–∞ —Ä–æ–∑–º–∏–Ω–∫–∞! –ú–∏ –ø–æ–±–∞—á–∏–ª–∏, –Ω–∞–¥ —á–∏–º –≤–∞—Ä—Ç–æ –ø–æ–ø—Ä–∞—Ü—é–≤–∞—Ç–∏. –ù–µ —Ö–≤–∏–ª—é–π—Å—è, –Ω–∞ —É—Ä–æ–∫–∞—Ö –º–∏ –≤—Å–µ —Ü–µ –¥–µ—Ç–∞–ª—å–Ω–æ —Ä–æ–∑–±–µ—Ä–µ–º–æ. –í—Å–µ –≤–∏–π–¥–µ!";
        }

        modal.classList.remove('hidden');
        setTimeout(() => modalContent.classList.remove('scale-95'), 10);
    }


    // --- –õ–û–ì–Ü–ö–ê –î–û–®–ö–ò (WHITEBOARD) ---
    const canvas = document.getElementById('whiteboard');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvas-wrap');
    
    let isDrawing = false;
    let currentTool = 'pen';
    let showGrid = false;

    function resizeCanvas() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        redrawCanvas();
    }

    function redrawCanvas() {
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        if (showGrid) drawGrid();
    }

    function setTool(tool) {
        currentTool = tool;
        document.getElementById('tool-pen').classList.toggle('tool-active', tool === 'pen');
        document.getElementById('tool-eraser').classList.toggle('tool-active', tool === 'eraser');
    }

    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches.length > 0 ? e.touches[0].clientX : 0);
        const clientY = e.clientY || (e.touches && e.touches.length > 0 ? e.touches[0].clientY : 0);
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function startPosition(e) {
        isDrawing = true;
        draw(e);
    }

    function endPosition() {
        isDrawing = false;
        ctx.beginPath();
    }

    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();

        const pos = getMousePos(e);

        ctx.lineWidth = currentTool === 'eraser' ? 30 : 3;
        ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : '#1e293b';

        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (showGrid) drawGrid();
    }

    function toggleGrid() {
        showGrid = !showGrid;
        const btn = document.getElementById('tool-grid');
        if (showGrid) {
            btn.classList.add('bg-slate-200', 'text-indigo-600');
            drawGrid();
        } else {
            btn.classList.remove('bg-slate-200', 'text-indigo-600');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }

    function drawGrid() {
        ctx.save();
        ctx.strokeStyle = '#f1f5f9';
        ctx.lineWidth = 1;
        const step = 40;
        
        ctx.beginPath();
        for (let x = 0; x <= canvas.width; x += step) {
            ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height);
        }
        for (let y = 0; y <= canvas.height; y += step) {
            ctx.moveTo(0, y); ctx.lineTo(canvas.width, y);
        }
        ctx.stroke();
        
        ctx.strokeStyle = '#cbd5e1';
        ctx.lineWidth = 2;
        const midX = Math.floor(canvas.width / 2 / step) * step;
        const midY = Math.floor(canvas.height / 2 / step) * step;
        
        ctx.beginPath();
        ctx.moveTo(midX, 0); ctx.lineTo(midX, canvas.height);
        ctx.moveTo(0, midY); ctx.lineTo(canvas.width, midY);
        ctx.stroke();
        ctx.restore();
    }

    function drawShape(type) {
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        ctx.strokeStyle = '#059669'; 
        ctx.lineWidth = 3;
        ctx.beginPath();

        if (type === 'triangle') {
            ctx.moveTo(cx, cy - 80);
            ctx.lineTo(cx + 80, cy + 60);
            ctx.lineTo(cx - 80, cy + 60);
            ctx.closePath();
        } else if (type === 'angle') {
            ctx.moveTo(cx - 80, cy - 50);
            ctx.lineTo(cx, cy + 50);
            ctx.lineTo(cx + 80, cy + 50);
        }
        ctx.stroke();
        ctx.beginPath();
        setTool('pen');
    }

    canvas.addEventListener('mousedown', startPosition);
    canvas.addEventListener('mouseup', endPosition);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseout', endPosition);

    canvas.addEventListener('touchstart', startPosition, { passive: false });
    canvas.addEventListener('touchend', endPosition);
    canvas.addEventListener('touchmove', draw, { passive: false });

    window.addEventListener('resize', resizeCanvas);

    window.onload = () => {
        renderTasks();
        setTimeout(resizeCanvas, 100);
    };

</script>
</body>
</html>