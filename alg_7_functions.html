<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathPro: –§—É–Ω–∫—Ü—ñ—è. –ë–∞–∑–æ–≤–∏–π —Ä—ñ–≤–µ–Ω—å (7 –∫–ª–∞—Å)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0fdf4; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #86efac; border-radius: 10px; }
        
        .task-card, .theory-card { border: 2px solid #bbf7d0; transition: all 0.3s ease; }
        .task-card:hover { border-color: #22c55e; transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(34, 197, 94, 0.1); }
        .solved-input { border-color: #22c55e !important; background-color: #dcfce7 !important; color: #166534 !important; pointer-events: none; }
        .error-input { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        
        .whiteboard-container { 
            background-color: #ffffff;
            background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px); 
            background-size: 25px 25px; 
        }
        .tool-active { background-color: #22c55e !important; color: white !important; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.5s ease-out forwards; }
        
        input[type="text"] { font-family: 'Courier New', Courier, monospace; font-weight: bold; text-align: center; font-size: 1.125rem;}
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div class="w-full lg:w-1/2 flex flex-col bg-white border-r border-green-100 shadow-2xl z-10">
        
        <header class="p-6 border-b border-green-50 flex justify-between items-center bg-white/95 backdrop-blur-md sticky top-0 z-20">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">Math<span class="text-green-500">Pro</span></h1>
                <p class="text-sm font-bold text-slate-400 mt-1">–§—É–Ω–∫—Ü—ñ—è ‚Ä¢ –ù–∞–π–ø—Ä–æ—Å—Ç—ñ—à—ñ –∫—Ä–æ–∫–∏</p>
            </div>
            <div class="flex flex-col items-end">
                <span class="text-sm font-extrabold text-green-600 mb-2" id="prog-text">0 / 15 –≤–∏–∫–æ–Ω–∞–Ω–æ</span>
                <div class="w-40 h-3 bg-green-50 rounded-full overflow-hidden shadow-inner">
                    <div id="prog-bar" class="h-full bg-green-500 transition-all duration-500 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 custom-scrollbar" id="content-scroll">
            <div id="lesson-container" class="space-y-6"></div>

            <div id="final-test" class="hidden mt-12 p-10 bg-gradient-to-br from-green-500 to-emerald-700 rounded-[2.5rem] text-white animate-fade shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 -mr-10 -mt-10 text-9xl opacity-20">üéØ</div>
                <h2 class="text-3xl font-black mb-6 flex items-center gap-3 relative z-10"><span>üß†</span> –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–Ω–∞–Ω—å</h2>
                <div id="test-questions" class="space-y-5 relative z-10"></div>
                <button onclick="finishLesson()" class="mt-10 w-full bg-white text-green-700 py-4 rounded-2xl font-black hover:bg-green-50 transition-all shadow-xl text-xl relative z-10">
                    –î–Ü–ó–ù–ê–¢–ò–°–Ø –†–ï–ó–£–õ–¨–¢–ê–¢!
                </button>
            </div>
        </main>
    </div>

    <div class="hidden lg:flex flex-1 flex-col bg-slate-50 p-5">
        <div class="mb-4 flex items-center justify-between bg-white p-3 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex gap-2">
                <button onclick="setTool('pen')" id="tool-pen" class="px-5 py-3 rounded-xl tool-active transition-all font-bold text-sm shadow-sm">‚úèÔ∏è –û–ª—ñ–≤–µ—Ü—å</button>
                <button onclick="setTool('eraser')" id="tool-eraser" class="px-5 py-3 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 transition-all font-bold text-sm">üßΩ –ì—É–º–∫–∞</button>
            </div>
            <div class="flex gap-2">
                <button onclick="drawGrid()" class="px-5 py-3 text-sm font-bold bg-green-50 text-green-600 rounded-xl hover:bg-green-100 transition-all">–°–Ü–¢–ö–ê</button>
                <button onclick="drawCoordinatePlane()" class="px-5 py-3 text-sm font-bold bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-100 transition-all">–û–°–Ü –ö–û–û–†–î–ò–ù–ê–¢</button>
                <div class="w-px h-10 bg-slate-200 mx-2 self-center"></div>
                <button onclick="clearCanvas()" class="px-5 py-3 text-sm font-bold bg-red-50 text-red-500 rounded-xl hover:bg-red-100 transition-all">–û–ß–ò–°–¢–ò–¢–ò</button>
            </div>
        </div>
        <div class="flex-1 whiteboard-container rounded-[2rem] border-2 border-slate-200 overflow-hidden relative cursor-crosshair shadow-inner" id="canvas-wrap">
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-50 hidden flex items-center justify-center p-6 transition-opacity">
        <div class="bg-white rounded-[3rem] p-12 max-w-md w-full text-center shadow-2xl relative overflow-hidden border-4 border-green-400">
            <div id="res-emoji" class="text-8xl mb-6 drop-shadow-lg">üéâ</div>
            <h2 id="res-title" class="text-4xl font-black text-slate-800 mb-4">–ú–æ–ª–æ–¥–µ—Ü—å!</h2>
            <p id="res-msg" class="text-slate-600 mb-8 text-lg font-bold">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ ‚Äî —Ü–µ –ø—Ä–æ—Å—Ç–æ, –ø—Ä–∞–≤–¥–∞?</p>
            <div class="bg-green-50 rounded-3xl p-6 mb-8 border-2 border-green-200">
                <span class="text-green-600 font-black text-6xl" id="res-score">12</span>
                <p class="text-sm uppercase font-extrabold text-green-800 mt-2 tracking-widest opacity-60">–¢–≤–æ—è –æ—Ü—ñ–Ω–∫–∞</p>
            </div>
            <button onclick="location.reload()" class="w-full bg-green-500 text-white py-5 rounded-2xl font-black hover:bg-green-600 transition-colors shadow-lg shadow-green-500/30 text-xl">–ü–û–í–¢–û–†–ò–¢–ò –£–†–û–ö</button>
        </div>
    </div>

<script>
    const lessonData = [
        {
            type: "theory",
            title: "üëã –ó–Ω–∞–π–æ–º—Å—Ç–≤–æ –∑ —Ñ—É–Ω–∫—Ü—ñ—î—é",
            text: `
                <p class="mb-4 text-lg">–£—è–≤–∏, —â–æ <b>—Ñ—É–Ω–∫—Ü—ñ—è</b> ‚Äî —Ü–µ —á–∞—Ä—ñ–≤–Ω–∞ –∫–æ—Ä–æ–±–∫–∞, —è–∫–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —á–∏—Å–ª–∞ –∑–∞ –ø–µ–≤–Ω–∏–º –ø—Ä–∞–≤–∏–ª–æ–º.</p>
                <ul class="space-y-3 mb-5 text-lg">
                    <li class="flex items-center gap-3"><span class="text-2xl">üì•</span> <b>–í—Ö—ñ–¥–Ω–µ —á–∏—Å–ª–æ (x)</b> ‚Äî —Ç–µ, —â–æ –º–∏ –∫–ª–∞–¥–µ–º–æ –≤ –∫–æ—Ä–æ–±–∫—É. –¶–µ <i>–∞—Ä–≥—É–º–µ–Ω—Ç</i>.</li>
                    <li class="flex items-center gap-3"><span class="text-2xl">üéÅ</span> <b>–†–µ–∑—É–ª—å—Ç–∞—Ç (y)</b> ‚Äî —Ç–µ, —â–æ –≤–∏–¥–∞—î –∫–æ—Ä–æ–±–∫–∞. –¶–µ <i>–∑–Ω–∞—á–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó</i>.</li>
                </ul>
                <p class="bg-green-100 text-green-900 p-4 rounded-2xl border-2 border-green-200 font-bold">
                    üëâ –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—Ä–∞–≤–∏–ª–æ: "–¥–æ–¥–∞–π 5".<br>–Ø–∫—â–æ –ø–æ–∫–ª–∞—Å—Ç–∏ 2, –æ—Ç—Ä–∏–º–∞—î–º–æ 7. –Ø–∫—â–æ 10, –æ—Ç—Ä–∏–º–∞—î–º–æ 15!
                </p>
            `
        },
        { type: "task", q: "–§–æ—Ä–º—É–ª–∞: \\( y = x + 5 \\). –ó–Ω–∞–π–¥–∏ \\( y \\), —è–∫—â–æ \\( x = 4 \\)", a: "9", h: "–ó–∞–º—ñ—Å—Ç—å x –ø–æ—Å—Ç–∞–≤ 4 —ñ –¥–æ–¥–∞–π 5.", s: "y = 4 + 5 = 9" },
        { type: "task", q: "–§–æ—Ä–º—É–ª–∞: \\( y = x - 3 \\). –ó–Ω–∞–π–¥–∏ \\( y \\), —è–∫—â–æ \\( x = 10 \\)", a: "7", h: "–í—ñ–¥ 10 –≤—ñ–¥–Ω—ñ–º–∏ 3.", s: "y = 10 - 3 = 7" },
        { type: "task", q: "–§–æ—Ä–º—É–ª–∞: \\( y = 2x \\) (—Ü–µ –æ–∑–Ω–∞—á–∞—î 2 –ø–æ–º–Ω–æ–∂–∏—Ç–∏ –Ω–∞ x). –ó–Ω–∞–π–¥–∏ \\( y \\), —è–∫—â–æ \\( x = 5 \\)", a: "10", h: "–ü–æ–º–Ω–æ–∂ 5 –Ω–∞ 2.", s: "y = 2 * 5 = 10" },
        { type: "task", q: "–§–æ—Ä–º—É–ª–∞: \\( y = \\frac{10}{x} \\) (—Ü–µ 10 –ø–æ–¥—ñ–ª–∏—Ç–∏ –Ω–∞ x). –ó–Ω–∞–π–¥–∏ \\( y \\), —è–∫—â–æ \\( x = 2 \\)", a: "5", h: "–ü–æ–¥—ñ–ª–∏ 10 –Ω–∞ 2.", s: "y = 10 / 2 = 5" },
        { type: "task", q: "–§–æ—Ä–º—É–ª–∞: \\( y = x^2 \\) (—Ü–µ x –ø–æ–º–Ω–æ–∂–∏—Ç–∏ —Å–∞–º–æ –Ω–∞ —Å–µ–±–µ). –ó–Ω–∞–π–¥–∏ \\( y \\), —è–∫—â–æ \\( x = 3 \\)", a: "9", h: "–ü–æ–º–Ω–æ–∂ 3 –Ω–∞ 3.", s: "y = 3 * 3 = 9" },

        {
            type: "theory",
            title: "üìä –¢–∞–±–ª–∏—á–Ω–∏–π —Å–ø–æ—Å—ñ–±",
            text: `
                <p class="text-lg">–Ü–Ω–æ–¥—ñ –¥—É–∂–µ –∑—Ä—É—á–Ω–æ –≤—Å—ñ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Å–∞—Ç–∏ –≤ —Ç–∞–±–ª–∏—Ü—é. –£ –≤–µ—Ä—Ö–Ω—å–æ–º—É —Ä—è–¥–∫—É –ø–∏—à—É—Ç—å –≤—Ö—ñ–¥–Ω—ñ —á–∏—Å–ª–∞ (\\( x \\)), –∞ –≤ –Ω–∏–∂–Ω—å–æ–º—É ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç (\\( y \\)).</p>
                <p class="mt-4 font-bold text-slate-700">–î–∞–≤–∞–π –∑–∞–ø–æ–≤–Ω–∏–º–æ –ø—Ä–æ—Å—Ç—É —Ç–∞–±–ª–∏—Ü—é –¥–ª—è —Ñ–æ—Ä–º—É–ª–∏ \\( y = x + 10 \\)!</p>
            `
        },
        {
            type: "table",
            title: "–ó–∞–ø–æ–≤–Ω–∏ —Ç–∞–±–ª–∏—Ü—é –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ—ó \\( y = x + 10 \\):",
            x_vals: [1, 2, 3, 4, 5],
            y_ans: [11, 12, 13, 14, 15],
            h: "–î–æ –∫–æ–∂–Ω–æ–≥–æ —á–∏—Å–ª–∞ –∑ –≤–µ—Ä—Ö–Ω—å–æ–≥–æ —Ä—è–¥–∫–∞ –ø—Ä–æ—Å—Ç–æ –¥–æ–¥–∞–≤–∞–π 10.",
            s: "–Ø–∫—â–æ x = 1, —Ç–æ y = 1 + 10 = 11.\n–Ø–∫—â–æ x = 2, —Ç–æ y = 2 + 10 = 12.\n–Ü —Ç–∞–∫ –¥–∞–ª—ñ."
        },

        {
            type: "theory",
            title: "üõë –ó–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ —á–∏—Å–ª–∞ (–û–±–ª–∞—Å—Ç—å –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è)",
            text: `
                <p class="text-lg">–î–µ—è–∫—ñ —á–∏—Å–ª–∞ –Ω–µ –º–æ–∂–Ω–∞ –∫–ª–∞—Å—Ç–∏ –≤ "—á–∞—Ä—ñ–≤–Ω—É –∫–æ—Ä–æ–±–∫—É", –±–æ –≤–æ–Ω–∞ –∑–ª–∞–º–∞—î—Ç—å—Å—è!</p>
                <p class="mt-4 text-red-600 font-black text-xl flex items-center gap-3">
                    <span>üö´</span> –ì–û–õ–û–í–ù–ï –ü–†–ê–í–ò–õ–û: –ù–ê –ù–£–õ–¨ –î–Ü–õ–ò–¢–ò –ù–ï –ú–û–ñ–ù–ê!
                </p>
                <p class="mt-4 text-lg">–Ø–∫—â–æ —É —Ñ–æ—Ä–º—É–ª—ñ —î –¥—ñ–ª–µ–Ω–Ω—è (–¥—Ä—ñ–±), —Ç—Ä–µ–±–∞ –∑–Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ, –ø—Ä–∏ —è–∫–æ–º—É –∑–Ω–∞–º–µ–Ω–Ω–∏–∫ —Å—Ç–∞–Ω–µ –Ω—É–ª–µ–º. –¶–µ —á–∏—Å–ª–æ ‚Äî –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–µ!</p>
            `
        },
        { type: "task", q: "–Ø–∫–µ —á–∏—Å–ª–æ –ù–ï –º–æ–∂–Ω–∞ –ø—ñ–¥—Å—Ç–∞–≤–ª—è—Ç–∏ —É —Ñ–æ—Ä–º—É–ª—É \\( y = \\frac{5}{x} \\)?", a: "0", h: "–ù–∞ —è–∫–µ —á–∏—Å–ª–æ –Ω–µ –º–æ–∂–Ω–∞ –¥—ñ–ª–∏—Ç–∏?", s: "–ù–∞ –Ω—É–ª—å –¥—ñ–ª–∏—Ç–∏ –Ω–µ –º–æ–∂–Ω–∞, —Ç–æ–º—É x –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ 0." },
        { type: "task", q: "–Ø–∫–µ —á–∏—Å–ª–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–µ –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ—ó \\( y = \\frac{12}{x - 2} \\)?", a: "2", h: "–ü—Ä–∏ —è–∫–æ–º—É x –≤–∏—Ä–∞–∑ (x - 2) –¥–æ—Ä—ñ–≤–Ω—é—î –Ω—É–ª—é? –í—ñ–¥ —è–∫–æ–≥–æ —á–∏—Å–ª–∞ —Ç—Ä–µ–±–∞ –≤—ñ–¥–Ω—è—Ç–∏ 2, —â–æ–± –≤–∏–π—à–æ–≤ –Ω—É–ª—å?", s: "2 - 2 = 0. –û—Ç–∂–µ, —á–∏—Å–ª–æ 2 –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–µ." },
        { type: "task", q: "–Ø–∫–µ —á–∏—Å–ª–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–µ –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ—ó \\( y = \\frac{7}{x - 10} \\)?", a: "10", h: "–©–æ–± –∑–Ω–∞–º–µ–Ω–Ω–∏–∫ —Å—Ç–∞–≤ –Ω—É–ª–µ–º, x –º–∞—î –¥–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ 10.", s: "10 - 10 = 0. –í—ñ–¥–ø–æ–≤—ñ–¥—å: 10." },
        { type: "task", q: "–Ø–∫–µ —á–∏—Å–ª–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–µ –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ—ó \\( y = \\frac{1}{x + 3} \\)?", a: "-3", h: "–Ø–∫–µ —á–∏—Å–ª–æ —Ç—Ä–µ–±–∞ –¥–æ–¥–∞—Ç–∏ –¥–æ 3, —â–æ–± –≤–∏–π—à–æ–≤ –Ω—É–ª—å? –ó–≥–∞–¥–∞–π –≤—ñ–¥'—î–º–Ω—ñ —á–∏—Å–ª–∞.", s: "-3 + 3 = 0. –ó–∞–±–æ—Ä–æ–Ω–µ–Ω–µ —á–∏—Å–ª–æ -3." },
        { type: "task", q: "–Ø–∫–µ —á–∏—Å–ª–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–µ –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ—ó \\( y = \\frac{9}{x + 1} \\)?", a: "-1", h: "–©–æ –¥–æ–¥–∞—Ç–∏ –¥–æ 1, —â–æ–± –≤–∏–π—à–æ–≤ 0?", s: "-1 + 1 = 0. –í—ñ–¥–ø–æ–≤—ñ–¥—å: -1." }
    ];

    let totalInputs = 0;
    let solvedInputs = 0;
    const inputsMap = new Map();

    function initLesson() {
        const container = document.getElementById('lesson-container');
        
        lessonData.forEach((block, idx) => {
            const el = document.createElement('div');
            el.className = 'animate-fade';
            el.style.animationDelay = `${idx * 0.1}s`;

            if (block.type === 'theory') {
                el.innerHTML = `
                    <div class="theory-card bg-white p-8 rounded-[2rem] shadow-sm mb-6 border-l-8 border-l-green-400">
                        <h3 class="text-2xl font-black text-slate-800 mb-4">${block.title}</h3>
                        <div class="text-slate-600">${block.text}</div>
                    </div>
                `;
            } 
            else if (block.type === 'task') {
                const id = `task_in_${totalInputs}`;
                inputsMap.set(id, { a: block.a });
                
                el.innerHTML = `
                    <div class="task-card bg-white p-8 rounded-[2rem] shadow-sm mb-6 relative overflow-hidden group">
                        <div class="absolute top-0 left-0 w-2 h-full bg-slate-200 group-hover:bg-green-400 transition-colors"></div>
                        <div class="text-xl font-bold text-slate-800 mb-6 pl-4">${block.q}</div>
                        <div class="flex gap-4 pl-4">
                            <input type="text" id="${id}" placeholder="?" 
                                class="w-24 sm:w-32 bg-slate-50 border-4 border-slate-100 rounded-2xl px-4 py-3 outline-none focus:border-green-400 transition-all text-2xl"
                                onkeypress="if(event.key==='Enter') checkAnswer('${id}')">
                            <button onclick="checkAnswer('${id}')" class="bg-slate-800 text-white px-8 rounded-2xl font-black hover:bg-green-500 transition-all text-lg shadow-lg">–ì–û–¢–û–í–û</button>
                        </div>
                        ${renderHelpers(idx, block.h, block.s)}
                    </div>
                `;
                totalInputs++;
            }
            else if (block.type === 'table') {
                let html = `
                    <div class="task-card bg-white p-8 rounded-[2rem] shadow-sm mb-6 border-l-8 border-l-blue-400">
                        <div class="text-xl font-bold text-slate-800 mb-6">${block.title}</div>
                        <div class="overflow-x-auto pb-4 custom-scrollbar">
                            <table class="w-full border-collapse text-center text-xl">
                                <tr>
                                    <td class="border-4 border-slate-100 p-4 bg-slate-50 font-black text-slate-700 rounded-tl-2xl w-20">\\( x \\)</td>
                `;
                block.x_vals.forEach(x => { html += `<td class="border-4 border-slate-100 p-4 font-bold text-slate-600 min-w-[80px]">${x}</td>`; });
                html += `</tr><tr><td class="border-4 border-slate-100 p-4 bg-slate-50 font-black text-slate-700 rounded-bl-2xl w-20">\\( y \\)</td>`;
                
                block.y_ans.forEach((ans) => {
                    const id = `task_in_${totalInputs}`;
                    inputsMap.set(id, { a: ans.toString() });
                    html += `<td class="border-4 border-slate-100 p-2">
                                <input type="text" id="${id}" class="w-full text-center bg-transparent border-none outline-none focus:bg-green-50 py-2 rounded-xl text-xl" onkeypress="if(event.key==='Enter') checkAnswer('${id}')">
                             </td>`;
                    totalInputs++;
                });
                html += `
                            </table>
                        </div>
                        <div class="mt-6">
                            <button onclick="checkTableBlock('${idx}')" class="w-full bg-blue-500 text-white py-4 rounded-2xl font-black hover:bg-blue-600 transition-all shadow-lg text-lg">–ü–ï–†–ï–í–Ü–†–ò–¢–ò –í–°–Æ –¢–ê–ë–õ–ò–¶–Æ</button>
                        </div>
                        ${renderHelpers(idx, block.h, block.s)}
                    </div>
                `;
                el.dataset.tableIds = Array.from({length: block.y_ans.length}, (_, i) => `task_in_${totalInputs - block.y_ans.length + i}`).join(',');
                el.innerHTML = html;
            }
            container.appendChild(el);
        });
        
        updateProgress();
        MathJax.typeset();
    }

    function renderHelpers(id, hint, solution) {
        return `
            <div class="mt-6 flex gap-4 pl-4">
                <button onclick="toggleHelper('h_${id}')" class="text-xs font-black text-orange-500 hover:text-orange-600 uppercase tracking-widest bg-orange-50 px-4 py-2 rounded-xl transition-colors">üí° –ü—ñ–¥–∫–∞–∑–∫–∞</button>
                <button onclick="toggleHelper('s_${id}')" class="text-xs font-black text-slate-400 hover:text-slate-600 uppercase tracking-widest bg-slate-100 px-4 py-2 rounded-xl transition-colors">üìù –Ø–∫ —Ä–æ–∑–≤'—è–∑–∞—Ç–∏?</button>
            </div>
            <div id="h_${id}" class="hidden mt-4 text-lg font-bold text-orange-800 bg-orange-100 p-5 rounded-2xl border-2 border-orange-200 ml-4">${hint}</div>
            <div id="s_${id}" class="hidden mt-4 text-lg font-mono font-bold text-slate-700 bg-slate-100 p-5 rounded-2xl border-2 border-slate-200 whitespace-pre-wrap ml-4">${solution}</div>
        `;
    }

    function toggleHelper(id) {
        document.getElementById(id).classList.toggle('hidden');
    }

    function checkAnswer(id) {
        const input = document.getElementById(id);
        if(input.disabled) return;

        const userVal = input.value.trim().replace(/\s+/g, '').replace('.', ',');
        const correctVal = inputsMap.get(id).a;

        if (userVal === correctVal) {
            solvedInputs++;
            input.classList.add('solved-input');
            input.classList.remove('error-input');
            input.disabled = true;
            updateProgress();
        } else {
            input.classList.add('error-input');
            input.classList.add('animate-pulse');
            setTimeout(() => {
                input.classList.remove('error-input');
                input.classList.remove('animate-pulse');
            }, 800);
        }
    }

    function checkTableBlock(idx) {
        const cards = document.querySelectorAll('.task-card');
        const card = cards[idx];
        if(!card || !card.dataset.tableIds) return;
        card.dataset.tableIds.split(',').forEach(id => checkAnswer(id));
    }

    function updateProgress() {
        const percent = (solvedInputs / totalInputs) * 100;
        document.getElementById('prog-bar').style.width = percent + '%';
        document.getElementById('prog-text').innerText = `${solvedInputs} / ${totalInputs} –≤–∏–∫–æ–Ω–∞–Ω–æ`;
        
        if (solvedInputs === totalInputs && document.getElementById('final-test').classList.contains('hidden')) {
            document.getElementById('final-test').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('content-scroll').scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 300);
            initTest();
        }
    }

    const testData = [
        { q: "–Ø–∫ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è —á–∏—Å–ª–æ (—Ö), —è–∫–µ –º–∏ '–∫–ª–∞–¥–µ–º–æ' —É —Ñ—É–Ω–∫—Ü—ñ—é?", opts: ["–ê—Ä–≥—É–º–µ–Ω—Ç", "–§—É–Ω–∫—Ü—ñ—è", "–ó–Ω–∞–º–µ–Ω–Ω–∏–∫"], a: 0 },
        { q: "–Ø–∫ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—É), —è–∫–∏–π –º–∏ –æ—Ç—Ä–∏–º—É—î–º–æ?", opts: ["–ê—Ä–≥—É–º–µ–Ω—Ç", "–§—É–Ω–∫—Ü—ñ—è", "–ó–Ω–∞–º–µ–Ω–Ω–∏–∫"], a: 1 },
        { q: "–ù–∞ —è–∫–µ —á–∏—Å–ª–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω–æ –ó–ê–ë–û–†–û–ù–ï–ù–û –¥—ñ–ª–∏—Ç–∏?", opts: ["–ù–∞ 1", "–ù–∞ 10", "–ù–∞ 0"], a: 2 }
    ];

    function initTest() {
        const cont = document.getElementById('test-questions');
        cont.innerHTML = testData.map((t, i) => `
            <div class="bg-white/20 p-6 rounded-3xl backdrop-blur-sm">
                <p class="font-black text-xl mb-4">${i+1}. ${t.q}</p>
                <div class="flex flex-col gap-3">
                    ${t.opts.map((opt, oIdx) => `
                        <label class="flex items-center gap-4 p-4 rounded-2xl bg-black/20 hover:bg-black/30 cursor-pointer transition-colors border-2 border-transparent has-[:checked]:border-white has-[:checked]:bg-white/30">
                            <input type="radio" name="test_${i}" value="${oIdx}" class="w-5 h-5 accent-green-500">
                            <span class="font-bold text-lg">${opt}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function finishLesson() {
        let testScore = 0;
        testData.forEach((t, i) => {
            const selected = document.querySelector(`input[name="test_${i}"]:checked`);
            if (selected && parseInt(selected.value) === t.a) testScore++;
        });

        const baseGrade = Math.floor((solvedInputs / totalInputs) * 9);
        const finalGrade = baseGrade + testScore;
        
        let msg = "–¢–∏ —Å—É–ø–µ—Ä! –¢–µ–º–∞ –∑–∞—Å–≤–æ—î–Ω–∞ –Ω–∞ –≤—ñ–¥–º—ñ–Ω–Ω–æ!";
        document.getElementById('res-score').innerText = finalGrade;
        document.getElementById('res-msg').innerText = msg;
        document.getElementById('modal').classList.remove('hidden');
    }

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let currentTool = 'pen';

    function resize() {
        const wrap = document.getElementById('canvas-wrap');
        const data = ctx.getImageData(0, 0, canvas.width || 1, canvas.height || 1);
        canvas.width = wrap.clientWidth;
        canvas.height = wrap.clientHeight;
        if(canvas.width > 0 && canvas.height > 0) ctx.putImageData(data, 0, 0);
    }

    function setTool(t) {
        currentTool = t;
        document.getElementById('tool-pen').classList.toggle('tool-active', t === 'pen');
        document.getElementById('tool-eraser').classList.toggle('tool-active', t === 'eraser');
        document.getElementById('tool-pen').classList.toggle('bg-slate-100', t !== 'pen');
        document.getElementById('tool-pen').classList.toggle('text-slate-600', t !== 'pen');
        document.getElementById('tool-eraser').classList.toggle('bg-slate-100', t !== 'eraser');
        document.getElementById('tool-eraser').classList.toggle('text-slate-600', t !== 'eraser');
    }

    function start(e) {
        drawing = true;
        ctx.beginPath();
        const pos = getPos(e);
        ctx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
        if (!drawing) return;
        e.preventDefault();
        const pos = getPos(e);
        ctx.lineWidth = currentTool === 'eraser' ? 35 : 3;
        if (currentTool === 'eraser') {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.strokeStyle = "rgba(0,0,0,1)";
        } else {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = '#1e293b';
        }
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }

    function stop() { 
        drawing = false; 
        ctx.globalCompositeOperation = 'source-over';
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    function drawGrid() {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = '#e2e8f0';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        for (let x = 0; x <= canvas.width; x += 30) { ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); }
        for (let y = 0; y <= canvas.height; y += 30) { ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); }
        ctx.stroke();
    }

    function drawCoordinatePlane() {
        clearCanvas();
        drawGrid();
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = '#0f172a';
        ctx.lineWidth = 3;
        const cx = Math.floor(canvas.width / 2 / 30) * 30;
        const cy = Math.floor(canvas.height / 2 / 30) * 30;
        
        ctx.beginPath();
        ctx.moveTo(0, cy); ctx.lineTo(canvas.width, cy);
        ctx.moveTo(canvas.width - 12, cy - 6); ctx.lineTo(canvas.width, cy); ctx.lineTo(canvas.width - 12, cy + 6);
        ctx.moveTo(cx, 0); ctx.lineTo(cx, canvas.height);
        ctx.moveTo(cx - 6, 12); ctx.lineTo(cx, 0); ctx.lineTo(cx + 6, 12);
        ctx.stroke();

        ctx.font = "bold 16px 'Nunito'";
        ctx.fillStyle = '#0f172a';
        ctx.fillText("x", canvas.width - 20, cy + 25);
        ctx.fillText("y", cx + 20, 20);
        ctx.fillText("0", cx - 20, cy + 20);
        ctx.fillText("1", cx + 30 - 5, cy + 22);
        ctx.fillText("1", cx - 20, cy - 30 + 5);
        
        ctx.beginPath();
        ctx.moveTo(cx + 30, cy - 5); ctx.lineTo(cx + 30, cy + 5);
        ctx.moveTo(cx - 5, cy - 30); ctx.lineTo(cx + 5, cy - 30);
        ctx.stroke();
    }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', draw);
    window.addEventListener('mouseup', stop);
    
    canvas.addEventListener('touchstart', start, {passive: false});
    canvas.addEventListener('touchmove', draw, {passive: false});
    window.addEventListener('touchend', stop);

    window.onload = () => {
        initLesson();
        const wrap = document.getElementById('canvas-wrap');
        canvas.width = wrap.clientWidth;
        canvas.height = wrap.clientHeight;
        window.addEventListener('resize', resize);
    };
</script>
</body>
</html>